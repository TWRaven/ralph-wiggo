# Ralph Progress Log
Started: Fri Feb 20 20:14:14 CET 2026

## Codebase Patterns
- Go module path: github.com/radvoogh/ralph-wiggo
- CLI entry point: cmd/ralph-wiggo/main.go
- Kong CLI framework: subcommands defined as struct fields on CLI type, with Run(globals *CLI) method
- Use `gb <branch-name>` for branch creation (git-machete), `gsn` for rebase+MR
- Fresh repos need an initial commit before `gb` works
- Embedded files live in `embedded/` package with `go:embed` directive in `embedded/embed.go`
- `internal/prompts` wraps the embedded FS — use `prompts.Get("filename.md")` to read content
- Override embedded files at runtime via `prompts.SetOverride(name, path)` or CLI `--prompt-override name=path`
- Kong `AfterApply()` method on CLI struct runs after flag parsing, before subcommand — used for setup logic
- `internal/claude` package: `Executor` wraps the claude CLI, `RunConfig` holds invocation params, `StreamEvent` models NDJSON output
- `RunStreaming` uses `exec.CommandContext` for cancellation, `bufio.Scanner` for NDJSON parsing, returns `<-chan StreamEvent`
- `RunInteractive` connects stdin/stdout/stderr to the terminal — no -p flag unless cfg.Prompt is set
- `RunJSON` uses `--output-format json` and `--json-schema`, captures stdout into buffer, parses result envelope
- Common args (model, turns, budget, etc.) extracted into `buildCommonArgs` — reused by all three modes
- `internal/prd` package: `PRD` and `UserStory` types with JSON tags, `LoadPRD`/`SavePRD` for file I/O, `Validate` for consistency checks
- `prd.JSONSchema` constant provides the JSON schema string for use with `claude --json-schema`
- `SavePRD` appends trailing newline for clean file output
- Subcommand implementations: load embedded skill via `prompts.Get()`, build `claude.RunConfig`, call executor method
- `signal.NotifyContext` for Ctrl+C handling in subcommands that spawn Claude
- `slugify` helper in main.go for kebab-case filename generation from user input
- `internal/planner` package: `NextStories(ctx, prd, mode, exec)` returns `[]*prd.UserStory` — pointers into the PRD slice so stories can be mutated in place
- Planner modes: "sequential" (single story), "parallel-N" (up to N stories), "auto" (Claude dependency analysis)
- `planner.JSONRunner` interface: accepted by `NextStories` for auto mode — satisfied by `*claude.Executor`, testable with mocks
- Auto mode falls back to sequential on any failure (nil executor, Claude error, invalid JSON, empty batches)
- `internal/git` package: all functions shell out via `os/exec` — use `run()` helper that returns trimmed combined output
- `CreateOrCheckoutBranch` tries checkout first, falls back to `checkout -b` for new branches
- `WorktreeAdd` creates worktree with `-b` flag to create a new branch at the path
- `CommitAll` does `git add -A` then `git commit -m` — stages everything including untracked files
- `RunStreaming` sends an error event if the process exits non-zero — callers use `exitedCleanly` bool to check success
- Per-story iteration tracking: `storyIterations map[string]int` and `skippedStories map[string]bool` in the run loop
- After PRD reload, story pointers are stale — capture `storyID` and `storyTitle` before reloading
- `internal/progress` package: `InitIfNeeded` creates header, `AppendEntry` logs iterations, `ArchiveIfBranchChanged` moves old run files to `archive/`
- Archive checks progress.txt `Branch:` header vs current PRD branchName — compares file header, not PRD file contents
- Parallel execution: worktrees created at `.ralph-wiggo/worktrees/<story-id>/`, branches named `worktree-<story-id>`
- Parallel results merged sequentially back to feature branch after all agents complete — avoids concurrent git ops on main repo
- `git.MergeFrom` + `git.AbortMerge` handle merge conflicts gracefully in parallel mode
- `storyResult` struct collects agent outcome + worktree info for deferred merge-back
- `printParallelEvent` prefixes output with `[story-id]` to distinguish concurrent agent output

---

## 2026-02-20 - US-001
- Implemented: Go project scaffolding with module init, kong CLI framework with 5 subcommands (run, prd, convert, serve, full) and global flags (--verbose, --model, --max-budget, --max-turns, --work-dir)
- Files changed: go.mod, go.sum, cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - Kong uses struct tags for CLI definition — subcommands are embedded structs with `cmd:""` tag
  - Each subcommand needs a `Run(globals *CLI) error` method
  - `gb` requires at least one commit to exist in the repo
  - Global flags are on the parent CLI struct, automatically available to all subcommands
---

## 2026-02-20 - US-002
- Implemented: Embedded prompt and skill files with go:embed, internal/prompts package with Get and override support, --prompt-override CLI flag
- Files changed: embedded/embed.go, embedded/prompt.md, embedded/prd-skill.md, embedded/ralph-skill.md, internal/prompts/prompts.go, internal/prompts/prompts_test.go, cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - `go:embed` can only embed files relative to the package directory — embedded files must live in or under the Go package that declares the embed directive
  - Solution: put embed.FS export in `embedded/` package, then import from `internal/prompts`
  - Kong `AfterApply()` on CLI struct is the right hook for pre-command setup (override registration)
  - Kong supports `[]string` flags that can be repeated: `--prompt-override a=b --prompt-override c=d`
---

## 2026-02-20 - US-003
- Implemented: Claude CLI executor package (internal/claude) with Executor struct, RunConfig, StreamEvent types, and RunStreaming method for spawning claude with NDJSON streaming output
- Files changed: internal/claude/claude.go
- **Learnings for future iterations:**
  - Claude CLI `--output-format stream-json` emits NDJSON — one JSON object per line with a `type` field
  - Use `exec.CommandContext` for context cancellation of subprocesses
  - `bufio.Scanner` needs a large buffer (10MB) for tool output lines that can be very large
  - Always drain stderr in a separate goroutine to prevent blocking the subprocess
  - `json.RawMessage` is useful for preserving raw event data while also parsing known fields
---

## 2026-02-20 - US-004
- Implemented: RunInteractive and RunJSON methods on Executor, refactored common arg building into buildCommonArgs
- Files changed: internal/claude/claude.go
- **Learnings for future iterations:**
  - Refactored `buildStreamingArgs` into `buildCommonArgs` + mode-specific prefix — keeps all three modes (streaming, interactive, JSON) DRY
  - `RunInteractive` connects os.Stdin/Stdout/Stderr directly — no pipe management needed
  - `RunJSON` captures stdout into `bytes.Buffer`, then parses the `result` envelope from `--output-format json`
  - Claude `--output-format json` wraps the response in a `{"result": ...}` envelope — parse and unwrap it
  - If the output doesn't have a `result` field, fall back to returning the raw JSON
---

## 2026-02-20 - US-005
- Implemented: PRD types (PRD, UserStory) with JSON parsing, LoadPRD/SavePRD file I/O, Validate function (unique IDs, sequential priorities), JSONSchema constant, and unit tests
- Files changed: internal/prd/prd.go, internal/prd/prd_test.go
- **Learnings for future iterations:**
  - `Validate` sorts a copy of stories by priority to check sequential ordering — this allows stories to be listed in any order in the JSON
  - `SavePRD` appends a trailing newline for cleaner file output and git diffs
  - `json.MarshalIndent` with 2-space indent matches the existing prd.json formatting convention
  - Test helper `testPRD()` returns a standard PRD fixture — reuse for consistency
---

## 2026-02-20 - US-006
- Implemented: PRD generation command (`ralph-wiggo prd <description>`) that launches Claude in interactive mode with embedded prd-skill.md as system prompt
- Files changed: cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - Subcommand pattern: load skill content via `prompts.Get()`, build `RunConfig` with `AppendSystemPrompt`, call `exec.RunInteractive`
  - Default output path uses `slugify()` to convert description to kebab-case: `tasks/prd-<slug>.md`
  - Include output path in the prompt text so Claude knows where to save the file
  - `signal.NotifyContext` wraps the context for graceful Ctrl+C handling during interactive sessions
  - `RunInteractive` with `cfg.Prompt` set uses `-p` to start the session with an initial message while still allowing interactive follow-up
---

## 2026-02-20 - US-007
- Implemented: PRD-to-JSON conversion command (`ralph-wiggo convert <prd-file.md>`) that reads a markdown PRD, sends it to Claude via RunJSON with ralph-skill.md as system prompt and prd.JSONSchema, validates the result, and writes prd.json
- Files changed: cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - Convert command follows same pattern as PRD command: load skill via `prompts.Get()`, build `RunConfig`, call executor
  - `RunJSON` with `prd.JSONSchema` constrains Claude output to valid PRD structure — parse with `json.Unmarshal` into `prd.PRD`
  - Validation warnings are printed to stderr but don't fail the command — lets the user see issues without blocking output
  - `prd.SavePRD` handles indented formatting and trailing newline — always use it instead of raw file writes
---

## 2026-02-20 - US-008
- Implemented: Story planner package (internal/planner) with NextStories function supporting sequential and parallel-N modes
- Files changed: internal/planner/planner.go, internal/planner/planner_test.go
- **Learnings for future iterations:**
  - `NextStories` returns `[]*prd.UserStory` — pointers into the PRD's slice, so callers can mutate stories in place
  - `incompleteByPriority` helper filters and sorts — reusable for future modes (e.g. auto mode in US-009)
  - Parallel mode parses N from "parallel-N" string format using `strings.TrimPrefix` + `strconv.Atoi`
  - Returns error for unknown modes — future modes (like "auto") will be added in US-009
---

## 2026-02-20 - US-009
- Implemented: Auto mode for story planner — sends incomplete stories to Claude via `JSONRunner` interface for dependency analysis, returns first incomplete batch, falls back to sequential on failure
- Files changed: internal/planner/planner.go, internal/planner/planner_test.go
- **Learnings for future iterations:**
  - Define narrow interfaces (`JSONRunner` with just `RunJSON`) in the consumer package, not the provider — keeps dependencies clean
  - `NextStories` signature changed to accept `context.Context` and `JSONRunner` — all callers need updating (ctx = `context.Background()` and exec = `nil` for non-auto modes)
  - Auto mode uses a `batchResponse` struct with `Batches [][]string` — Claude returns story IDs grouped by dependency
  - Fallback strategy: log the error + return sequential result (never propagate auto-mode errors to callers)
  - `mockJSONRunner` pattern: struct with `response` and `err` fields satisfies the interface for deterministic tests
  - Auto mode skips batches where all stories are already complete — finds the first batch with at least one incomplete story
---

## 2026-02-20 - US-010
- Implemented: Git operations package (internal/git) with CreateOrCheckoutBranch, WorktreeAdd, WorktreeRemove, CommitAll, CurrentBranch functions
- Files changed: internal/git/git.go
- **Learnings for future iterations:**
  - All git functions use a shared `run()` helper that calls `exec.Command("git", ...)` and returns trimmed combined output
  - `CreateOrCheckoutBranch` tries `git checkout` first, falls back to `git checkout -b` — handles both existing and new branches
  - `WorktreeAdd` uses `git worktree add -b <branch> <path>` — creates a new branch at the worktree path
  - `WorktreeRemove` uses `--force` flag to ensure cleanup even if worktree has uncommitted changes
  - `CommitAll` does `git add -A` (stages everything including untracked) then `git commit -m`
- Agent loop (`RunCmd.Run`): loads PRD, checks out branch, loops calling `planner.NextStories` + `exec.RunStreaming`, reloads PRD each iteration
- Agent invocation: `--dangerously-skip-permissions`, `--allowedTools Bash,Read,Edit,Write,Glob,Grep`, prompt.md as `--append-system-prompt`
- `buildStoryPrompt` and `printStreamEvent` are helper functions in main.go for the agent loop
  - Error messages include the git subcommand name and stderr output for debuggability
---

## 2026-02-20 - US-011
- Implemented: Agent loop core sequential execution — `ralph-wiggo run` reads prd.json, creates/checks out feature branch, loops through stories via planner.NextStories (sequential mode), spawns Claude agents via RunStreaming with embedded prompt.md, prints streaming events, exits when all pass or max iterations reached
- Files changed: cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - `RunCmd.Run` reloads prd.json after each iteration to pick up changes the agent made (story passes, etc.)
  - Agent gets `--dangerously-skip-permissions` and `--allowedTools Bash,Read,Edit,Write,Glob,Grep`
  - `buildStoryPrompt` formats story details (ID, title, description, acceptance criteria, notes) as markdown for the agent
  - `printStreamEvent` handles all event types: assistant text printed inline, tool_use/tool_result as bracketed indicators, errors to stderr
  - The loop checks `planner.NextStories` at the top of each iteration — when all stories pass, it returns empty slice and the loop breaks
  - `--max-iterations` flag (default 10) is a global safety net; future US-012 will add per-story iteration tracking
---

## 2026-02-20 - US-012
- Implemented: Story verification and prd.json updates — agent loop now tracks per-story iterations, marks stories as passed on clean exit (code 0), commits changes via git.CommitAll, skips stories that exceed max-iterations, and prints per-iteration summaries
- Files changed: internal/claude/claude.go, cmd/ralph-wiggo/main.go
- **Learnings for future iterations:**
  - `RunStreaming` goroutine now captures `cmd.Wait()` error and emits an error event — previously the exit code was silently discarded
  - After reloading PRD with `prd.LoadPRD`, all previous `*prd.UserStory` pointers are stale — must capture ID/title before reload and find the story in the reloaded slice by ID
  - Per-story iteration tracking uses two maps: `storyIterations` (attempt count) and `skippedStories` (exceeded max)
  - The planner doesn't know about skipped stories — the run loop filters them out after `NextStories` returns
  - `--max-iterations` is now per-story, not global — the loop terminates when all stories either pass or are skipped
---

## 2026-02-20 - US-013
- Implemented: Progress.txt management and run archiving — new `internal/progress` package with `InitIfNeeded`, `AppendEntry`, and `ArchiveIfBranchChanged` functions; integrated into `RunCmd.Run` in main.go
- Files changed: internal/progress/progress.go, internal/progress/progress_test.go, cmd/ralph-wiggo/main.go, internal/prd/prd.go (reverted back), prd.json
- **Learnings for future iterations:**
  - `progress.InitIfNeeded` uses `os.Stat` to check existence — noop if file already exists
  - `progress.AppendEntry` collects `StreamEvent` slice from the run loop, summarizes tool usage (deduped counts) and errors
  - Archive logic compares progress.txt's `Branch:` header line with the current PRD's branchName — not the on-disk prd.json, since that may already have been overwritten by `convert`
  - `readProgressBranch` scans the header (stops at `---` separator) for the `Branch:` line
  - Archive copies prd.json as a snapshot (doesn't move it) since the current PRD still needs to exist at the original path
  - Archive directory naming: `archive/YYYY-MM-DD-<feature-name>/` where feature-name is the old branchName with `ralph/` prefix stripped
  - Collect events in a `[]claude.StreamEvent` slice during the streaming loop — pass to `AppendEntry` after determining pass/fail
  - `progressPath` is derived from `filepath.Dir(r.PRDPath)` + "progress.txt" — keeps progress.txt alongside prd.json
---

## 2026-02-20 - US-014
- Implemented: Parallel execution with worktrees — when planner returns multiple stories (parallel-N or auto mode), the run loop creates git worktrees in `.ralph-wiggo/worktrees/<story-id>/`, spawns concurrent Claude agents (one per worktree), then merges results back sequentially
- Files changed: internal/git/git.go (added MergeFrom, AbortMerge, DeleteBranch), cmd/ralph-wiggo/main.go (refactored run loop with runSingleAgent, runParallelAgents, processStoryResult, processParallelResults helpers)
- **Learnings for future iterations:**
  - Refactored the monolithic run loop into composable helpers: `runSingleAgent` (single-story), `runParallelAgents` (multi-story with worktrees), `processStoryResult`, `processParallelResults`
  - `storyResult` struct captures storyID, storyTitle, passed, events, worktreeBranch, worktreePath, iterNum — all info needed for deferred merge-back
  - Parallel agents use `sync.WaitGroup` + mutex-protected results slice — simpler than errgroup since we want all agents to run to completion
  - Worktree cleanup happens in a deferred function after `wg.Wait()` — ensures cleanup even if merging fails
  - `git.MergeFrom` + `git.AbortMerge` handle merge conflicts: abort restores working tree so subsequent merges can proceed
  - `printParallelEvent` prefixes all output with `[story-id]` so concurrent agent output can be distinguished
  - Sequential path (1 story) preserved as-is — parallel path only activates when planner returns >1 story
---
